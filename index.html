<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>שלי מזרחי ביטוח - מערכת ניהול פרופילי משפחה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Heebo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .drop-zone { 
            border: 2px dashed #3b82f6; 
            transition: all 0.3s ease; 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
        }
        
        .drop-zone.dragover { 
            border-color: #60a5fa; 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(147, 51, 234, 0.2) 100%);
            transform: scale(1.02);
        }
        
        .progress-bar { 
            transition: width 0.3s ease; 
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
        }
        
        .family-card { 
            animation: slideIn 0.5s ease-out; 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
            border: 1px solid #475569;
            position: relative;
            overflow: hidden;
        }
        
        .family-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
        }
        
        @keyframes slideIn { 
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        .floating-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        /* Ensure family name is always white */
        .family-card h3 {
            color: white !important;
        }
            pointer-events: none;
        }
        
        .floating-element {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .ai-insights-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .weather-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }
        
        .news-card {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Floating Background Elements -->
    <div class="floating-elements">
        <div class="floating-element" style="top: 10%; left: 10%; animation-delay: 0s;">
            <i class="fas fa-shield-alt text-4xl text-white"></i>
        </div>
        <div class="floating-element" style="top: 20%; right: 15%; animation-delay: 2s;">
            <i class="fas fa-chart-line text-3xl text-white"></i>
        </div>
        <div class="floating-element" style="bottom: 30%; left: 20%; animation-delay: 4s;">
            <i class="fas fa-users text-4xl text-white"></i>
        </div>
        <div class="floating-element" style="bottom: 20%; right: 10%; animation-delay: 1s;">
            <i class="fas fa-file-alt text-3xl text-white"></i>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-effect shadow-2xl border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="relative">
                        <div class="h-16 w-16 rounded-2xl glass-effect flex items-center justify-center mr-2 shadow-lg">
                            <img src="sheli-logo.png" alt="שלי מזרחי ביטוח" class="h-12 w-12 object-contain">
                        </div>
                        <div class="absolute -top-2 -right-2 h-6 w-6 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="mr-2">
                        <h1 class="text-2xl font-bold text-white mb-1">שלי מזרחי ביטוח</h1>
                        <p class="text-sm text-white/80">מערכת ניהול פרופילי משפחה - AI Powered</p>
                        <div class="flex items-center mt-1">
                            <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                            <span class="text-xs text-white/70">מערכת פעילה</span>
                        </div>
                    </div>
                </div>
                
                <div class="text-right">
                    <div class="stats-card rounded-xl p-4 mb-2">
                        <div class="text-sm text-white/80">סך משפחות: <span id="totalFamilies" class="font-semibold text-blue-300">0</span></div>
                    </div>
                    <div class="stats-card rounded-xl p-4">
                        <div class="text-sm text-white/80">סך פוליסות: <span id="totalPolicies" class="font-semibold text-green-300">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Welcome Dashboard Section -->
        <div class="hero-gradient rounded-2xl shadow-2xl p-8 mb-8 text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-black/10"></div>
            <div class="relative z-10">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Personal Greeting -->
                    <div class="lg:col-span-2">
                        <div class="flex items-center mb-6">
                            <div class="h-12 w-12 bg-white/20 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-user-circle text-2xl"></i>
                            </div>
                            <div>
                                <h2 class="text-3xl font-bold">שלום שלי! 👋</h2>
                                <p class="text-white/80">ברוכה הבאה למערכת הניהול המתקדמת שלך</p>
                            </div>
                        </div>
                        
                        <div id="personalGreeting" class="text-white/90 mb-6">
                            <p class="text-lg mb-2">מערכת AI חכמה לניהול פרופילי משפחה ועיבוד קבצי Excel</p>
                            <p class="text-sm text-white/70">מערכת משולבת עם BMAD, MCP servers ו-Superdesigner</p>
                        </div>
                        
                        <div id="aiInsights" class="ai-insights-card rounded-xl p-6 border border-white/20">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-brain text-2xl mr-3"></i>
                                <h3 class="text-xl font-semibold">💡 תובנות AI מתקדמות</h3>
                            </div>
                            <div id="insightsContent" class="text-white/90">
                                <div class="pulse-animation">טוען תובנות מתקדמות...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats & Weather -->
                    <div class="space-y-6">
                        <div class="weather-card rounded-xl p-6 border border-white/20">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-cloud-sun text-2xl mr-2"></i>
                                <h3 class="text-xl font-semibold">🌤️ מזג אוויר</h3>
                            </div>
                            <div id="weatherInfo" class="text-white/90">
                                <div class="pulse-animation">טוען מידע מזג אוויר...</div>
                            </div>
                        </div>
                        
                        <div class="stats-card rounded-xl p-6">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-chart-bar text-2xl mr-2 text-white"></i>
                                <h3 class="text-xl font-semibold text-white">📊 סטטיסטיקות מהירות</h3>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-white/80">משפחות היום:</span>
                                    <span class="font-semibold text-blue-300" id="todayFamilies">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-white/80">קבצים שעובדו:</span>
                                    <span class="font-semibold text-green-300" id="processedFiles">0</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-white/80">תהליכי AI:</span>
                                    <span class="font-semibold text-purple-300" id="aiProcesses">3</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insurance News Section -->
        <div class="news-card rounded-2xl shadow-2xl p-8 mb-8 border border-white/20">
            <div class="flex items-center mb-6">
                <i class="fas fa-newspaper text-3xl mr-4"></i>
                <h2 class="text-3xl font-bold text-white">📰 חדשות ביטוח בישראל</h2>
            </div>
            <div id="insuranceNews" class="space-y-4">
                <div class="pulse-animation text-white/80">טוען חדשות ביטוח מתקדמות...</div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="glass-effect rounded-2xl shadow-2xl p-8 mb-8 border border-white/20">
            <div class="flex items-center mb-6">
                <i class="fas fa-cloud-upload-alt text-3xl mr-4 text-white"></i>
                <h2 class="text-3xl font-bold text-white">העלאת קבצי Excel</h2>
            </div>
            
            <!-- Upload Zone -->
            <div id="uploadZone" class="drop-zone rounded-2xl p-12 text-center cursor-pointer mb-6 border-2 border-dashed border-white/40">
                <div class="space-y-6">
                    <div class="h-20 w-20 mx-auto bg-white/10 rounded-full flex items-center justify-center">
                        <i class="fas fa-file-excel text-4xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-xl font-medium text-white mb-2">גרור קבצי Excel לכאן</p>
                        <p class="text-white/70">או לחץ לבחירת קבצים</p>
                        <p class="text-sm text-white/50 mt-2">מערכת AI תעבד את הקבצים ותצור פרופילי משפחה</p>
                    </div>
                    <input type="file" id="fileInput" multiple accept=".xlsx,.xls" class="hidden">
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="hidden">
                <div class="glass-effect rounded-xl p-6 mb-6 border border-white/20">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-lg font-medium text-white" id="progressText">מעבד קבצים...</span>
                        <span class="text-lg text-blue-300" id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-white/20 rounded-full h-3 mb-4">
                        <div id="progressBar" class="progress-bar h-3 rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="processingSteps" class="space-y-3">
                        <!-- Processing steps will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Family Profiles Section -->
        <div class="glass-effect rounded-2xl shadow-2xl p-8 border border-white/20">
            <div class="flex items-center mb-8">
                <i class="fas fa-users text-3xl mr-4 text-white"></i>
                <h2 class="text-3xl font-bold text-white">פרופילי משפחה</h2>
            </div>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stats-card p-6 rounded-xl text-center border border-white/20">
                    <div class="text-3xl font-bold text-blue-300 mb-2" id="summaryFamilies">0</div>
                    <div class="text-white/80">משפחות</div>
                    <i class="fas fa-home text-2xl text-blue-300 mt-3"></i>
                </div>
                <div class="stats-card p-6 rounded-xl text-center border border-white/20">
                    <div class="text-3xl font-bold text-emerald-300 mb-2" id="summaryPolicies">0</div>
                    <div class="text-white/80">פוליסות</div>
                    <i class="fas fa-file-contract text-2xl text-emerald-300 mt-3"></i>
                </div>
                <div class="stats-card p-6 rounded-xl text-center border border-white/20">
                    <div class="text-3xl font-bold text-orange-300 mb-2" id="summaryPremium">₪0</div>
                    <div class="text-white/80">סך פרמיה חודשית</div>
                    <i class="fas fa-money-bill-wave text-2xl text-orange-300 mt-3"></i>
                </div>
                <div class="stats-card p-6 rounded-xl text-center border border-white/20">
                    <div class="text-3xl font-bold text-purple-300 mb-2" id="summaryValue">₪0</div>
                    <div class="text-white/80">ערך שנתי</div>
                    <i class="fas fa-chart-line text-2xl text-purple-300 mt-3"></i>
                </div>
            </div>

            <!-- Family Cards Container -->
            <div id="familyCards" class="space-y-6">
                <!-- Family cards will be dynamically added here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-16">
                <div class="h-24 w-24 mx-auto bg-white/10 rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-users text-4xl text-white/50"></i>
                </div>
                <h3 class="text-xl font-medium text-white mb-2">אין פרופילי משפחה</h3>
                <p class="text-white/70 mb-6">העלה קבצי Excel כדי להתחיל</p>
                <div class="flex items-center justify-center space-x-4 text-white/50">
                    <i class="fas fa-robot"></i>
                    <span>מערכת AI מוכנה לעיבוד</span>
                    <i class="fas fa-brain"></i>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8000';
        const OPENAI_API_KEY = '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';
        
        // Global state
        let families = [];
        let isProcessing = false;

        // DOM elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const processingSteps = document.getElementById('processingSteps');
        const familyCards = document.getElementById('familyCards');
        const emptyState = document.getElementById('emptyState');

        // Event listeners
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', handleDragOver);
        uploadZone.addEventListener('dragleave', handleDragLeave);
        uploadZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadFamilies();
            loadOpenAIContent(); // Load OpenAI-powered content
        });

        // API Functions
        async function loadFamilies() {
            try {
                const response = await axios.get(`${API_BASE_URL}/api/families`);
                families = response.data.families || [];
                updateDisplay();
            } catch (error) {
                console.error('Error loading families:', error);
                showError('שגיאה בטעינת נתונים');
            }
        }

        async function uploadFiles(files) {
            const formData = new FormData();
            files.forEach(file => {
                formData.append('files', file);
            });

            try {
                const response = await axios.post(`${API_BASE_URL}/api/upload`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                return response.data;
            } catch (error) {
                console.error('Upload error:', error);
                throw new Error(error.response?.data?.detail || 'שגיאה בהעלאת קבצים');
            }
        }

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        // File processing
        async function processFiles(files) {
            if (isProcessing) return;
            
            const excelFiles = files.filter(file => 
                file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
            );

            if (excelFiles.length === 0) {
                alert('אנא בחר קבצי Excel בלבד');
                return;
            }

            isProcessing = true;
            showProgress();
            
            try {
                // Update progress steps
                await updateProgress(10, 'מעלה קבצים לשרת...', 'fas fa-cloud-upload-alt');
                
                // Upload files to API
                const result = await uploadFiles(excelFiles);
                
                await updateProgress(30, 'מעבד עם BMAD...', 'fas fa-cogs');
                await sleep(1000);
                
                await updateProgress(50, 'מחבר לשרתי MCP...', 'fas fa-server');
                await sleep(1000);
                
                await updateProgress(70, 'יוצר פרופיל משפחה...', 'fas fa-user-plus');
                await sleep(1000);
                
                await updateProgress(90, 'שומר במסד נתונים...', 'fas fa-database');
                await sleep(500);
                
                await updateProgress(100, 'הושלם בהצלחה!', 'fas fa-check-circle');
                
                // Add new family to the list
                families.push(result.profile);
                
                // Update display
                updateDisplay();
                
                // Show success message
                showSuccess(`פרופיל משפחה "${result.profile.family_name}" נוסף בהצלחה!`);
                
            } catch (error) {
                console.error('Processing error:', error);
                showError(error.message || 'שגיאה בעיבוד הקבצים');
            } finally {
                isProcessing = false;
                hideProgress();
            }
        }

        // Progress handling
        function showProgress() {
            progressSection.classList.remove('hidden');
            processingSteps.innerHTML = '';
            updateProgress(0, 'מתחיל עיבוד...', 'fas fa-play');
        }

        function hideProgress() {
            progressSection.classList.add('hidden');
        }

        async function updateProgress(percent, text, icon) {
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${Math.round(percent)}%`;
            progressText.textContent = text;
            
            // Add step to processing steps
            const step = document.createElement('div');
            step.className = 'flex items-center text-white/80';
            step.innerHTML = `
                <i class="${icon} text-green-400 mr-3"></i>
                <span>${text}</span>
            `;
            processingSteps.appendChild(step);
        }

        // Display updates
        function updateDisplay() {
            updateSummary();
            updateFamilyCards();
            updateEmptyState();
        }

        function updateSummary() {
            const totalFamilies = families.length;
            const totalPolicies = families.reduce((sum, family) => sum + family.total_policies, 0);
            const totalPremium = families.reduce((sum, family) => sum + family.total_monthly_premium, 0);
            const totalValue = totalPremium * 12;

            document.getElementById('totalFamilies').textContent = totalFamilies;
            document.getElementById('totalPolicies').textContent = totalPolicies;
            document.getElementById('summaryFamilies').textContent = totalFamilies;
            document.getElementById('summaryPolicies').textContent = totalPolicies;
            document.getElementById('summaryPremium').textContent = `₪${totalPremium.toLocaleString()}`;
            document.getElementById('summaryValue').textContent = `₪${totalValue.toLocaleString()}`;
        }

        function updateFamilyCards() {
            familyCards.innerHTML = '';
            
            families.forEach(family => {
                const card = createFamilyCard(family);
                familyCards.appendChild(card);
            });
        }

        function createFamilyCard(family) {
            const card = document.createElement('div');
            card.className = 'family-card rounded-xl p-6 border border-white/20 text-white';
            card.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="h-12 w-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-home text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">${family.family_name}</h3>
                            <p class="text-white/70">${family.analysis_date}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-white/60">AI Enhanced</div>
                        <div class="text-xs text-blue-300">BMAD Processed</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="text-center bg-white/10 rounded-lg p-4">
                        <div class="text-2xl font-semibold text-blue-300 mb-1">${family.total_members}</div>
                        <div class="text-white/70">חברי משפחה</div>
                        <i class="fas fa-users text-blue-300 mt-2"></i>
                    </div>
                    <div class="text-center bg-white/10 rounded-lg p-4">
                        <div class="text-2xl font-semibold text-emerald-300 mb-1">${family.total_policies}</div>
                        <div class="text-white/70">פוליסות</div>
                        <i class="fas fa-file-contract text-emerald-300 mt-2"></i>
                    </div>
                    <div class="text-center bg-white/10 rounded-lg p-4">
                        <div class="text-2xl font-semibold text-orange-300 mb-1">₪${family.total_monthly_premium.toLocaleString()}</div>
                        <div class="text-white/70">חודשי</div>
                        <i class="fas fa-money-bill-wave text-orange-300 mt-2"></i>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    ${family.family_members.map(member => `
                        <div class="flex items-center bg-white/10 rounded-lg p-4">
                            <div class="flex items-center flex-1">
                                <div class="h-8 w-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="font-medium">${member.name}</div>
                                    <div class="text-sm text-white/70">${member.policies} פוליסות - ${member.type}</div>
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="font-semibold">₪${member.premium.toLocaleString()}</div>
                                <div class="text-sm text-white/50">חודשי</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="pt-4 border-t border-white/20">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-robot text-blue-300"></i>
                            <span class="text-blue-300 text-sm">${family.analysis_method}</span>
                        </div>
                        <button onclick="openAgentRequest()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 flex items-center space-x-2">
                            <i class="fas fa-plus"></i>
                            <span>בקשה לסוכן נוסף</span>
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        function updateEmptyState() {
            if (families.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }
        }

        // Typeform Integration
        const TYPEFORM_API_KEY = 'tfp_5bDzhMy6Eo5MyM45a8J77krKoBQPDzJhF1VvTmxeBcgL_3mJ8Hw4wfHYT5D';
        const TYPEFORM_ID = 'Dehvvdjx';
        
        function openAgentRequest() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'agentModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                    <div class="text-center mb-6">
                        <div class="h-16 w-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-robot text-white text-2xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">בקשה לסוכן AI נוסף</h3>
                        <p class="text-gray-600">מלאו את הפרטים ונציג שלנו יצור איתכם קשר</p>
                    </div>
                    
                    <form id="agentForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">שם מלא</label>
                            <input type="text" name="fullName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">אימייל</label>
                            <input type="email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">טלפון</label>
                            <input type="tel" name="phone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">סוג הסוכן הנדרש</label>
                            <select name="agentType" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">בחרו סוג סוכן</option>
                                <option value="customer-service">שירות לקוחות</option>
                                <option value="sales">מכירות</option>
                                <option value="claims">תביעות</option>
                                <option value="underwriting">כתיבת פוליסות</option>
                                <option value="analytics">ניתוח נתונים</option>
                                <option value="custom">סוכן מותאם אישית</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">תיאור הצרכים</label>
                            <textarea name="description" rows="3" placeholder="תארו את הצרכים שלכם..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="closeAgentModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                ביטול
                            </button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all duration-300 transform hover:scale-105">
                                <i class="fas fa-paper-plane mr-2"></i>
                                שלח בקשה
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('agentForm').addEventListener('submit', handleAgentRequest);
        }
        
        function closeAgentModal() {
            const modal = document.getElementById('agentModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function handleAgentRequest(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                agentType: formData.get('agentType'),
                description: formData.get('description'),
                source: 'Sheli Mizrahi Insurance Dashboard',
                timestamp: new Date().toISOString()
            };
            
            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>שולח...';
                submitBtn.disabled = true;
                
                // Send to Typeform
                const response = await submitToTypeform(data);
                
                // Close modal and show success
                closeAgentModal();
                showSuccess('הבקשה נשלחה בהצלחה! נציג שלנו יצור איתכם קשר בקרוב.');
                
            } catch (error) {
                console.error('Error submitting agent request:', error);
                showError('שגיאה בשליחת הבקשה. אנא נסו שוב.');
                
                // Reset button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        async function submitToTypeform(data) {
            try {
                // Map our data to Typeform field references
                const typeformData = {
                    "form_id": TYPEFORM_ID,
                    "submitted_at": new Date().toISOString(),
                    "answers": [
                        {
                            "field": {
                                "id": "Jl4ug1UEMVSp",
                                "type": "short_text"
                            },
                            "type": "text",
                            "text": data.fullName
                        },
                        {
                            "field": {
                                "id": "fHNjlNf4CXRy",
                                "type": "email"
                            },
                            "type": "email",
                            "email": data.email
                        },
                        {
                            "field": {
                                "id": "HKX18wb2cRTx",
                                "type": "phone_number"
                            },
                            "type": "phone_number",
                            "phone_number": data.phone || ""
                        },
                        {
                            "field": {
                                "id": "TQQxBTLJCX9a",
                                "type": "multiple_choice"
                            },
                            "type": "choice",
                            "choice": {
                                "id": getChoiceId(data.agentType)
                            }
                        },
                        {
                            "field": {
                                "id": "aVjsVbZrztX3",
                                "type": "long_text"
                            },
                            "type": "text",
                            "text": data.description || ""
                        }
                    ]
                };

                // Send to Typeform API
                const response = await fetch(`https://api.typeform.com/forms/${TYPEFORM_ID}/responses`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${TYPEFORM_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(typeformData)
                });

                if (!response.ok) {
                    throw new Error(`Typeform API error: ${response.status}`);
                }

                // Also send to our backend for logging
                await axios.post(`${API_BASE_URL}/api/agent-request`, data);
                
                return { success: true, message: "Submitted to Typeform successfully" };
            } catch (error) {
                console.error('Typeform submission error:', error);
                // Fallback to backend only
                const response = await axios.post(`${API_BASE_URL}/api/agent-request`, data);
                return response.data;
            }
        }

        function getChoiceId(agentType) {
            const choiceMap = {
                'customer-service': 'Y1filDcmmYUY',
                'sales': 'a1UTCkYUNe98',
                'claims': 'c2YSPIdbWQVz',
                'underwriting': 'jVK7KjIofrLD',
                'analytics': '0VByxhUl9gwB',
                'custom': 'KaOuOpY48V58'
            };
            return choiceMap[agentType] || 'KaOuOpY48V58'; // Default to custom
        }
        
        // Utility functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center';
            notification.innerHTML = `
                <i class="fas fa-check-circle mr-3"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-red-500 to-pink-500 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center';
            notification.innerHTML = `
                <i class="fas fa-exclamation-triangle mr-3"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // OpenAI Integration Functions
        async function loadOpenAIContent() {
            try {
                // Load AI insights
                await loadAIInsights();
                
                // Load weather information
                await loadWeatherInfo();
                
                // Load insurance news
                await loadInsuranceNews();
                
            } catch (error) {
                console.error('Error loading OpenAI content:', error);
            }
        }

        async function loadAIInsights() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/openai/insights`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.success && data.insights) {
                    document.getElementById('insightsContent').innerHTML = data.insights.replace(/\n/g, '<br>');
                } else {
                    document.getElementById('insightsContent').innerHTML = 'לא ניתן לטעון תובנות כרגע';
                }
            } catch (error) {
                console.error('Error loading AI insights:', error);
                document.getElementById('insightsContent').innerHTML = 'לא ניתן לטעון תובנות כרגע';
            }
        }

        async function loadWeatherInfo() {
            try {
                const weatherResponse = await fetch(`${API_BASE_URL}/api/openai/weather`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const weatherData = await weatherResponse.json();
                if (weatherData.success && weatherData.weather) {
                    document.getElementById('weatherInfo').innerHTML = weatherData.weather.replace(/\n/g, '<br>');
                } else {
                    document.getElementById('weatherInfo').innerHTML = 'לא ניתן לטעון מידע מזג אוויר';
                }
            } catch (error) {
                console.error('Error loading weather:', error);
                document.getElementById('weatherInfo').innerHTML = 'לא ניתן לטעון מידע מזג אוויר';
            }
        }

        async function loadInsuranceNews() {
            try {
                const newsResponse = await fetch(`${API_BASE_URL}/api/openai/news`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const newsData = await newsResponse.json();
                if (newsData.success && newsData.news) {
                    const news = newsData.news;
                    const newsItems = news.split('\n').filter(item => item.trim());
                    
                    let newsHTML = '';
                    newsItems.forEach(item => {
                        if (item.trim()) {
                            newsHTML += `<div class="bg-white/10 rounded-lg p-4 border-r-4 border-white/30">
                                <p class="text-white/90">${item.trim()}</p>
                            </div>`;
                        }
                    });
                    
                    document.getElementById('insuranceNews').innerHTML = newsHTML;
                } else {
                    document.getElementById('insuranceNews').innerHTML = '<div class="text-white/80">לא ניתן לטעון חדשות כרגע</div>';
                }
            } catch (error) {
                console.error('Error loading insurance news:', error);
                document.getElementById('insuranceNews').innerHTML = '<div class="text-white/80">לא ניתן לטעון חדשות כרגע</div>';
            }
        }
    </script>
</body>
</html>
